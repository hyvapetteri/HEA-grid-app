"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var GridDirection;
(function (GridDirection) {
    GridDirection[GridDirection["Up"] = 0] = "Up";
    GridDirection[GridDirection["Down"] = 1] = "Down";
    GridDirection[GridDirection["Right"] = 2] = "Right";
    GridDirection[GridDirection["Left"] = 3] = "Left";
})(GridDirection = exports.GridDirection || (exports.GridDirection = {}));
var TrialAnswer;
(function (TrialAnswer) {
    TrialAnswer["Correct"] = "correct";
    TrialAnswer["Wrong"] = "wrong";
})(TrialAnswer = exports.TrialAnswer || (exports.TrialAnswer = {}));
var GridTracker = (function () {
    function GridTracker(params) {
        this.grid = params.g;
        this.m_up = params.m_up;
        this.n_down = params.n_down;
        this.answerBuffer = new Array(Math.max(params.m_up, params.n_down));
        this.n_max_reversals = params.n_revs;
        this.n_max_steps = params.n_step;
        this.initialized = false;
    }
    GridTracker.prototype.getLastNAnswers = function (n) {
        var i = Math.min(this.answerBuffer.length, Math.abs(n));
        return this.answerBuffer.slice(-1 * i);
    };
    GridTracker.prototype.getStatus = function () {
        return this.status;
    };
    GridTracker.prototype.getHistory = function () {
        return this.history;
    };
    GridTracker.prototype.getStepsize = function () {
        return this.status.stepsize;
    };
    GridTracker.prototype.setStepsize = function (xstep, ystep) {
        this.status.stepsize = [xstep, ystep];
    };
    GridTracker.prototype.initialize = function (x, y) {
        this.status = {
            xidx: x,
            yidx: y,
            stepsize: [1, 1],
            direction: GridDirection.Up,
            adjust_difficulty: 0,
            finished: false
        };
        this.history = [];
        this.reversal_counter = 0;
        this.initialized = true;
    };
    GridTracker.prototype.updatePosition = function (ans) {
        if (!this.initialized) {
            throw new Error('Tracker not initialized.');
        }
        if (this.status.finished) {
            throw new Error('Tracker has already finished. Re-initialize to start a new run.');
        }
        this.answerBuffer.shift();
        this.answerBuffer.push(ans);
        this.status.answer = ans;
        // compute the m-up-n-down rule
        if (ans == TrialAnswer.Correct) {
            var n_down_buffer = this.getLastNAnswers(this.n_down);
            if (n_down_buffer.every(function (a) { return a == TrialAnswer.Correct; })) {
                this.status.adjust_difficulty = -1; // negative -> go down = increase difficulty
                this.answerBuffer = new Array(this.answerBuffer.length); // reset buffer
            }
            else {
                this.status.adjust_difficulty = 0; // not yet n correct answers, keep going
            }
        }
        else if (ans == TrialAnswer.Wrong) {
            var m_up_buffer = this.getLastNAnswers(this.m_up);
            if (m_up_buffer.every(function (a) { return a == TrialAnswer.Wrong; })) {
                this.status.adjust_difficulty = 1; // positive ->  go up = decrease difficulty
                this.answerBuffer = new Array(this.answerBuffer.length);
            }
            else {
                this.status.adjust_difficulty = 0;
            }
        }
        // determine next grid direction
        if (this.status.adjust_difficulty < 0) {
            if (this.status.direction == GridDirection.Up) {
                this.status.direction = GridDirection.Left;
            }
            else if (this.status.direction == GridDirection.Right) {
                this.status.direction = GridDirection.Down;
            } // otherwise current direction is down or left -> keep going
        }
        else if (this.status.adjust_difficulty > 0) {
            if (this.status.direction == GridDirection.Down) {
                this.status.direction = GridDirection.Right;
            }
            else if (this.status.direction == GridDirection.Left) {
                this.status.direction = GridDirection.Up;
            } // otherwise current direction is up or right -> keep going
        }
        // determine new position towards the chosen direction
        var new_yidx = this.status.yidx;
        var new_xidx = this.status.xidx;
        switch (this.status.direction) {
            case GridDirection.Up:
                new_yidx = new_yidx + this.status.stepsize[1];
                break;
            case GridDirection.Right:
                new_xidx = new_xidx + this.status.stepsize[0];
                break;
            case GridDirection.Down:
                new_yidx = new_yidx - this.status.stepsize[1];
                break;
            case GridDirection.Left:
                new_xidx = new_xidx - this.status.stepsize[0];
                break;
        }
        // check if we reached the grid boundaries
        if (new_yidx > this.grid.getYlim()[1]) {
            if (this.status.direction == GridDirection.Up) {
                // max y value reached, change direction to right, i.e. keep
                // decreasing difficulty
                new_yidx = this.grid.getYlim()[1];
                this.status.direction = GridDirection.Right;
                this.status.reversal = true;
                this.reversal_counter = this.reversal_counter + 1;
                new_xidx = new_xidx + this.status.stepsize[0];
                if (new_xidx > this.grid.getXlim[1]) {
                    throw new Error('Grid: Upper right corner reached.');
                }
            }
            else {
                throw new Error('Grid: unexpected direction when reaching upper y boundary.');
            }
        }
        else if (new_yidx < this.grid.getYlim[0]) {
            if (this.status.direction == GridDirection.Down) {
                // min y value reached, change direction to left, i.e. keep
                // increasing difficulty
                new_yidx = this.grid.getYlim()[0];
                this.status.direction = GridDirection.Left;
                this.status.reversal = true;
                this.reversal_counter = this.reversal_counter + 1;
                new_xidx = new_xidx - this.status.stepsize[0];
                if (new_xidx < this.grid.getXlim()[0]) {
                    throw new Error('Grid: Lower left corner reached.');
                }
            }
            else {
                throw new Error('Grid: unexpected direction when reaching lower y boundary.');
            }
        }
        else if (new_xidx > this.grid.getXlim[1]) {
            if (this.status.direction == GridDirection.Right) {
                // max x value reached, change direction to up, i.e. keep
                // decreasing difficulty
                new_xidx = this.grid.getXlim()[1];
                this.status.direction = GridDirection.Up;
                this.status.reversal = true;
                this.reversal_counter = this.reversal_counter + 1;
                new_yidx = new_yidx + this.status.stepsize[1];
                if (new_yidx > this.grid.getYlim()[1]) {
                    throw new Error('Grid: Upper right corner reached.');
                }
            }
            else {
                throw new Error('Grid: unexpected direction when reaching upper x boundary.');
            }
        }
        else if (new_xidx < this.grid.getXlim[0]) {
            if (this.status.direction == GridDirection.Left) {
                // min x value reached, change direction to down, i.e. keep
                // increasing difficulty
                new_xidx = this.grid.getXlim()[0];
                this.status.direction = GridDirection.Down;
                this.status.reversal = true;
                this.reversal_counter = this.reversal_counter + 1;
                new_yidx = new_yidx - this.status.stepsize[1];
                if (new_yidx < this.grid.getYlim()[0]) {
                    throw new Error('Grid: Lower left corner reached.');
                }
            }
            else {
                throw new Error('Grid: unexpected direction when reaching lower x boundary.');
            }
        }
        // check stopping conditions
        if (this.reversal_counter >= this.n_max_reversals) {
            this.status.finished = true;
        }
        if (this.history.length >= this.n_max_steps - 1) {
            this.status.finished = true;
        }
        // save the status to grid history
        var status_clone = Object.assign({}, this.status);
        this.history.push(status_clone);
        // move to new point
        this.status.xidx = new_xidx;
        this.status.yidx = new_yidx;
    };
    GridTracker.prototype.getCurrentGridParameters = function () {
        return this.grid.getGridValues(this.status.xidx, this.status.yidx);
    };
    return GridTracker;
}());
exports.GridTracker = GridTracker;
var ParamGrid = (function () {
    function ParamGrid(params) {
        if (params.xmax < params.xmin) {
            throw new Error('xmin must be less than xmax');
        }
        this.xlim = [params.xmin, params.xmax];
        if (params.ymax < params.ymin) {
            throw new Error('ymin must be less than ymax');
        }
        this.ylim = [params.ymin, params.ymax];
        this.xresolution = params.xres;
        this.yresolution = params.yres;
        var x_size = Math.floor((params.xmax - params.xmin) / params.xres) + 1;
        this.xvalues = new Array(x_size);
        this.x_max_idx = x_size - 1;
        for (var i = 0; i < this.x_max_idx; i++) {
            this.xvalues[i] = params.xmin + i * params.xres;
        }
        this.xvalues[this.x_max_idx] = params.xmax;
        var y_size = Math.floor((params.ymax - params.ymin) / params.yres) + 1;
        this.yvalues = new Array(y_size);
        this.y_max_idx = y_size - 1;
        for (var i = 0; i < this.y_max_idx; i++) {
            this.yvalues[i] = params.ymin + i * params.yres;
        }
        this.yvalues[this.y_max_idx] = params.ymax;
    }
    ParamGrid.prototype.getXlim = function () {
        return this.xlim;
    };
    ParamGrid.prototype.getYlim = function () {
        return this.ylim;
    };
    ParamGrid.prototype.getGridValues = function (xidx, yidx) {
        if (xidx > this.x_max_idx) {
            throw new Error('xidx exceeds grid range');
        }
        if (yidx > this.y_max_idx) {
            throw new Error('yidx exceeds grid range');
        }
        return [this.xvalues[xidx], this.yvalues[yidx]];
    };
    return ParamGrid;
}());
exports.ParamGrid = ParamGrid;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdyaWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFZLGFBS1g7QUFMRCxXQUFZLGFBQWE7SUFDdkIsNkNBQUUsQ0FBQTtJQUNGLGlEQUFJLENBQUE7SUFDSixtREFBSyxDQUFBO0lBQ0wsaURBQUksQ0FBQTtBQUNOLENBQUMsRUFMVyxhQUFhLEdBQWIscUJBQWEsS0FBYixxQkFBYSxRQUt4QjtBQUVELElBQVksV0FHWDtBQUhELFdBQVksV0FBVztJQUNyQixrQ0FBbUIsQ0FBQTtJQUNuQiw4QkFBZSxDQUFBO0FBQ2pCLENBQUMsRUFIVyxXQUFXLEdBQVgsbUJBQVcsS0FBWCxtQkFBVyxRQUd0QjtBQWNEO0lBWUUscUJBQVksTUFBb0Y7UUFDOUYsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDNUIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUNqQyxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztJQUMzQixDQUFDO0lBRUQscUNBQWUsR0FBZixVQUFnQixDQUFTO1FBQ3ZCLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FB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QUFiLFVBQWMsSUFBSSxFQUFFLElBQUk7UUFDdEIsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUM3QyxDQUFDO1FBRUQsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVILGdCQUFDO0FBQUQsQ0FBQyxBQTlERCxJQThEQztBQTlEWSw4QkFBUyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBlbnVtIEdyaWREaXJlY3Rpb24ge1xuICBVcCxcbiAgRG93bixcbiAgUmlnaHQsXG4gIExlZnRcbn1cblxuZXhwb3J0IGVudW0gVHJpYWxBbnN3ZXIge1xuICBDb3JyZWN0ID0gXCJjb3JyZWN0XCIsXG4gIFdyb25nID0gXCJ3cm9uZ1wiXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR3JpZFRyYWNraW5nU3RhdHVzIHtcbiAgeGlkeDogbnVtYmVyO1xuICB5aWR4OiBudW1iZXI7XG4gIGRpcmVjdGlvbjogR3JpZERpcmVjdGlvbjtcbiAgYWRqdXN0X2RpZmZpY3VsdHk6IG51bWJlcjtcbiAgZmluaXNoZWQ6IGJvb2xlYW47XG4gIGFuc3dlcj86IFRyaWFsQW5zd2VyO1xuICBjb3JyZWN0PzogYm9vbGVhbjtcbiAgc3RlcHNpemU/OiBbbnVtYmVyLCBudW1iZXJdO1xuICByZXZlcnNhbD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjbGFzcyBHcmlkVHJhY2tlciB7XG4gIHByaXZhdGUgZ3JpZDogUGFyYW1HcmlkO1xuICBwcml2YXRlIHN0YXR1czogR3JpZFRyYWNraW5nU3RhdHVzO1xuICBwcml2YXRlIGhpc3Rvcnk6IEFycmF5PEdyaWRUcmFja2luZ1N0YXR1cz47XG4gIHByaXZhdGUgbV91cDogbnVtYmVyO1xuICBwcml2YXRlIG5fZG93bjogbnVtYmVyO1xuICBwcml2YXRlIGFuc3dlckJ1ZmZlcjogQXJyYXk8VHJpYWxBbnN3ZXI+O1xuICBwcml2YXRlIG5fbWF4X3JldmVyc2FsczogbnVtYmVyO1xuICBwcml2YXRlIHJldmVyc2FsX2NvdW50ZXI6IG51bWJlcjtcbiAgcHJpdmF0ZSBuX21heF9zdGVwczogbnVtYmVyO1xuICBwcml2YXRlIGluaXRpYWxpemVkOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKHBhcmFtczoge2c6IFBhcmFtR3JpZCwgbV91cDogbnVtYmVyLCBuX2Rvd246IG51bWJlciwgbl9yZXZzOiBudW1iZXIsIG5fc3RlcDogbnVtYmVyfSkge1xuICAgIHRoaXMuZ3JpZCA9IHBhcmFtcy5nO1xuICAgIHRoaXMubV91cCA9IHBhcmFtcy5tX3VwO1xuICAgIHRoaXMubl9kb3duID0gcGFyYW1zLm5fZG93bjtcbiAgICB0aGlzLmFuc3dlckJ1ZmZlciA9IG5ldyBBcnJheShNYXRoLm1heChwYXJhbXMubV91cCwgcGFyYW1zLm5fZG93bikpO1xuICAgIHRoaXMubl9tYXhfcmV2ZXJzYWxzID0gcGFyYW1zLm5fcmV2cztcbiAgICB0aGlzLm5fbWF4X3N0ZXBzID0gcGFyYW1zLm5fc3RlcDtcbiAgICB0aGlzLmluaXRpYWxpemVkID0gZmFsc2U7XG4gIH1cblxuICBnZXRMYXN0TkFuc3dlcnMobjogbnVtYmVyKTogVHJpYWxBbnN3ZXJbXSB7XG4gICAgbGV0IGkgPSBNYXRoLm1pbih0aGlzLmFuc3dlckJ1ZmZlci5sZW5ndGgsIE1hdGguYWJzKG4pKTtcbiAgICByZXR1cm4gdGhpcy5hbnN3ZXJCdWZmZXIuc2xpY2UoLTEqaSk7XG4gIH1cblxuICBnZXRTdGF0dXMoKTogR3JpZFRyYWNraW5nU3RhdHVzIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0dXM7XG4gIH1cblxuICBnZXRIaXN0b3J5KCk6IEdyaWRUcmFja2luZ1N0YXR1c1tdIHtcbiAgICByZXR1cm4gdGhpcy5oaXN0b3J5O1xuICB9XG5cbiAgZ2V0U3RlcHNpemUoKTogW251bWJlciwgbnVtYmVyXSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdHVzLnN0ZXBzaXplO1xuICB9XG5cbiAgc2V0U3RlcHNpemUoeHN0ZXA6bnVtYmVyLCB5c3RlcDpudW1iZXIpIHtcbiAgICB0aGlzLnN0YXR1cy5zdGVwc2l6ZSA9IFt4c3RlcCwgeXN0ZXBdO1xuICB9XG5cbiAgaW5pdGlhbGl6ZSh4Om51bWJlciwgeTpudW1iZXIpIHtcbiAgICB0aGlzLnN0YXR1cyA9IHtcbiAgICAgIHhpZHg6IHgsXG4gICAgICB5aWR4OiB5LFxuICAgICAgc3RlcHNpemU6IFsxLCAxXSxcbiAgICAgIGRpcmVjdGlvbjogR3JpZERpcmVjdGlvbi5VcCxcbiAgICAgIGFkanVzdF9kaWZmaWN1bHR5OiAwLFxuICAgICAgZmluaXNoZWQ6IGZhbHNlXG4gICAgfVxuXG4gICAgdGhpcy5oaXN0b3J5ID0gW107XG4gICAgdGhpcy5yZXZlcnNhbF9jb3VudGVyID0gMDtcbiAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgfVxuXG4gIHVwZGF0ZVBvc2l0aW9uKGFuczogVHJpYWxBbnN3ZXIpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVHJhY2tlciBub3QgaW5pdGlhbGl6ZWQuJyk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXR1cy5maW5pc2hlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcmFja2VyIGhhcyBhbHJlYWR5IGZpbmlzaGVkLiBSZS1pbml0aWFsaXplIHRvIHN0YXJ0IGEgbmV3IHJ1bi4nKTtcbiAgICB9XG5cbiAgICB0aGlzLmFuc3dlckJ1ZmZlci5zaGlmdCgpO1xuICAgIHRoaXMuYW5zd2VyQnVmZmVyLnB1c2goYW5zKTtcbiAgICB0aGlzLnN0YXR1cy5hbnN3ZXIgPSBhbnM7XG5cbiAgICAvLyBjb21wdXRlIHRoZSBtLXVwLW4tZG93biBydWxlXG4gICAgaWYgKGFucyA9PSBUcmlhbEFuc3dlci5Db3JyZWN0KSB7XG4gICAgICBsZXQgbl9kb3duX2J1ZmZlciA9IHRoaXMuZ2V0TGFzdE5BbnN3ZXJzKHRoaXMubl9kb3duKTtcbiAgICAgIGlmIChuX2Rvd25fYnVmZmVyLmV2ZXJ5KGEgPT4gYSA9PSBUcmlhbEFuc3dlci5Db3JyZWN0KSkge1xuICAgICAgICB0aGlzLnN0YXR1cy5hZGp1c3RfZGlmZmljdWx0eSA9IC0xOyAvLyBuZWdhdGl2ZSAtPiBnbyBkb3duID0gaW5jcmVhc2UgZGlmZmljdWx0eVxuICAgICAgICB0aGlzLmFuc3dlckJ1ZmZlciA9IG5ldyBBcnJheSh0aGlzLmFuc3dlckJ1ZmZlci5sZW5ndGgpOyAvLyByZXNldCBidWZmZXJcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc3RhdHVzLmFkanVzdF9kaWZmaWN1bHR5ID0gMDsgLy8gbm90IHlldCBuIGNvcnJlY3QgYW5zd2Vycywga2VlcCBnb2luZ1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoYW5zID09IFRyaWFsQW5zd2VyLldyb25nKSB7XG4gICAgICBsZXQgbV91cF9idWZmZXIgPSB0aGlzLmdldExhc3ROQW5zd2Vycyh0aGlzLm1fdXApO1xuICAgICAgaWYgKG1fdXBfYnVmZmVyLmV2ZXJ5KGEgPT4gYSA9PSBUcmlhbEFuc3dlci5Xcm9uZykpIHtcbiAgICAgICAgdGhpcy5zdGF0dXMuYWRqdXN0X2RpZmZpY3VsdHkgPSAxOyAvLyBwb3NpdGl2ZSAtPiAgZ28gdXAgPSBkZWNyZWFzZSBkaWZmaWN1bHR5XG4gICAgICAgIHRoaXMuYW5zd2VyQnVmZmVyID0gbmV3IEFycmF5KHRoaXMuYW5zd2VyQnVmZmVyLmxlbmd0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN0YXR1cy5hZGp1c3RfZGlmZmljdWx0eSA9IDA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZGV0ZXJtaW5lIG5leHQgZ3JpZCBkaXJlY3Rpb25cbiAgICBpZiAodGhpcy5zdGF0dXMuYWRqdXN0X2RpZmZpY3VsdHkgPCAwKSB7IC8vIGdvIGRvd24gPSBpbmNyZWFzZSBkaWZmaWN1bHR5XG4gICAgICAgIGlmICh0aGlzLnN0YXR1cy5kaXJlY3Rpb24gPT0gR3JpZERpcmVjdGlvbi5VcCkge1xuICAgICAgICAgIHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9IEdyaWREaXJlY3Rpb24uTGVmdDtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXR1cy5kaXJlY3Rpb24gPT0gR3JpZERpcmVjdGlvbi5SaWdodCkge1xuICAgICAgICAgIHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9IEdyaWREaXJlY3Rpb24uRG93bjtcbiAgICAgICAgfSAvLyBvdGhlcndpc2UgY3VycmVudCBkaXJlY3Rpb24gaXMgZG93biBvciBsZWZ0IC0+IGtlZXAgZ29pbmdcbiAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzLmFkanVzdF9kaWZmaWN1bHR5ID4gMCkgeyAvLyBnbyB1cCA9IGRlY3JlYXNlIGRpZmZpY3VsdHlcbiAgICAgIGlmICh0aGlzLnN0YXR1cy5kaXJlY3Rpb24gPT0gR3JpZERpcmVjdGlvbi5Eb3duKSB7XG4gICAgICAgIHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9IEdyaWREaXJlY3Rpb24uUmlnaHQ7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9PSBHcmlkRGlyZWN0aW9uLkxlZnQpIHtcbiAgICAgICAgdGhpcy5zdGF0dXMuZGlyZWN0aW9uID0gR3JpZERpcmVjdGlvbi5VcDtcbiAgICAgIH0gLy8gb3RoZXJ3aXNlIGN1cnJlbnQgZGlyZWN0aW9uIGlzIHVwIG9yIHJpZ2h0IC0+IGtlZXAgZ29pbmdcbiAgICB9XG5cbiAgICAvLyBkZXRlcm1pbmUgbmV3IHBvc2l0aW9uIHRvd2FyZHMgdGhlIGNob3NlbiBkaXJlY3Rpb25cbiAgICBsZXQgbmV3X3lpZHggPSB0aGlzLnN0YXR1cy55aWR4O1xuICAgIGxldCBuZXdfeGlkeCA9IHRoaXMuc3RhdHVzLnhpZHg7XG4gICAgc3dpdGNoICh0aGlzLnN0YXR1cy5kaXJlY3Rpb24pIHtcbiAgICAgIGNhc2UgR3JpZERpcmVjdGlvbi5VcDpcbiAgICAgICAgbmV3X3lpZHggPSBuZXdfeWlkeCArIHRoaXMuc3RhdHVzLnN0ZXBzaXplWzFdO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgR3JpZERpcmVjdGlvbi5SaWdodDpcbiAgICAgICAgbmV3X3hpZHggPSBuZXdfeGlkeCArIHRoaXMuc3RhdHVzLnN0ZXBzaXplWzBdO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgR3JpZERpcmVjdGlvbi5Eb3duOlxuICAgICAgICBuZXdfeWlkeCA9IG5ld195aWR4IC0gdGhpcy5zdGF0dXMuc3RlcHNpemVbMV07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBHcmlkRGlyZWN0aW9uLkxlZnQ6XG4gICAgICAgIG5ld194aWR4ID0gbmV3X3hpZHggLSB0aGlzLnN0YXR1cy5zdGVwc2l6ZVswXTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgaWYgd2UgcmVhY2hlZCB0aGUgZ3JpZCBib3VuZGFyaWVzXG4gICAgaWYgKG5ld195aWR4ID4gdGhpcy5ncmlkLmdldFlsaW0oKVsxXSkge1xuICAgICAgaWYgKHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9PSBHcmlkRGlyZWN0aW9uLlVwKSB7XG4gICAgICAgIC8vIG1heCB5IHZhbHVlIHJlYWNoZWQsIGNoYW5nZSBkaXJlY3Rpb24gdG8gcmlnaHQsIGkuZS4ga2VlcFxuICAgICAgICAvLyBkZWNyZWFzaW5nIGRpZmZpY3VsdHlcbiAgICAgICAgbmV3X3lpZHggPSB0aGlzLmdyaWQuZ2V0WWxpbSgpWzFdO1xuICAgICAgICB0aGlzLnN0YXR1cy5kaXJlY3Rpb24gPSBHcmlkRGlyZWN0aW9uLlJpZ2h0O1xuICAgICAgICB0aGlzLnN0YXR1cy5yZXZlcnNhbCA9IHRydWU7XG4gICAgICAgIHRoaXMucmV2ZXJzYWxfY291bnRlciA9IHRoaXMucmV2ZXJzYWxfY291bnRlciArIDE7XG4gICAgICAgIG5ld194aWR4ID0gbmV3X3hpZHggKyB0aGlzLnN0YXR1cy5zdGVwc2l6ZVswXTtcbiAgICAgICAgaWYgKG5ld194aWR4ID4gdGhpcy5ncmlkLmdldFhsaW1bMV0pIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dyaWQ6IFVwcGVyIHJpZ2h0IGNvcm5lciByZWFjaGVkLicpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dyaWQ6IHVuZXhwZWN0ZWQgZGlyZWN0aW9uIHdoZW4gcmVhY2hpbmcgdXBwZXIgeSBib3VuZGFyeS4nKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKG5ld195aWR4IDwgdGhpcy5ncmlkLmdldFlsaW1bMF0pIHtcbiAgICAgIGlmICh0aGlzLnN0YXR1cy5kaXJlY3Rpb24gPT0gR3JpZERpcmVjdGlvbi5Eb3duKSB7XG4gICAgICAgIC8vIG1pbiB5IHZhbHVlIHJlYWNoZWQsIGNoYW5nZSBkaXJlY3Rpb24gdG8gbGVmdCwgaS5lLiBrZWVwXG4gICAgICAgIC8vIGluY3JlYXNpbmcgZGlmZmljdWx0eVxuICAgICAgICBuZXdfeWlkeCA9IHRoaXMuZ3JpZC5nZXRZbGltKClbMF07XG4gICAgICAgIHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9IEdyaWREaXJlY3Rpb24uTGVmdDtcbiAgICAgICAgdGhpcy5zdGF0dXMucmV2ZXJzYWwgPSB0cnVlO1xuICAgICAgICB0aGlzLnJldmVyc2FsX2NvdW50ZXIgPSB0aGlzLnJldmVyc2FsX2NvdW50ZXIgKyAxO1xuICAgICAgICBuZXdfeGlkeCA9IG5ld194aWR4IC0gdGhpcy5zdGF0dXMuc3RlcHNpemVbMF07XG4gICAgICAgIGlmIChuZXdfeGlkeCA8IHRoaXMuZ3JpZC5nZXRYbGltKClbMF0pIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dyaWQ6IExvd2VyIGxlZnQgY29ybmVyIHJlYWNoZWQuJyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR3JpZDogdW5leHBlY3RlZCBkaXJlY3Rpb24gd2hlbiByZWFjaGluZyBsb3dlciB5IGJvdW5kYXJ5LicpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAobmV3X3hpZHggPiB0aGlzLmdyaWQuZ2V0WGxpbVsxXSkge1xuICAgICAgaWYgKHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9PSBHcmlkRGlyZWN0aW9uLlJpZ2h0KSB7XG4gICAgICAgIC8vIG1heCB4IHZhbHVlIHJlYWNoZWQsIGNoYW5nZSBkaXJlY3Rpb24gdG8gdXAsIGkuZS4ga2VlcFxuICAgICAgICAvLyBkZWNyZWFzaW5nIGRpZmZpY3VsdHlcbiAgICAgICAgbmV3X3hpZHggPSB0aGlzLmdyaWQuZ2V0WGxpbSgpWzFdO1xuICAgICAgICB0aGlzLnN0YXR1cy5kaXJlY3Rpb24gPSBHcmlkRGlyZWN0aW9uLlVwO1xuICAgICAgICB0aGlzLnN0YXR1cy5yZXZlcnNhbCA9IHRydWU7XG4gICAgICAgIHRoaXMucmV2ZXJzYWxfY291bnRlciA9IHRoaXMucmV2ZXJzYWxfY291bnRlciArIDE7XG4gICAgICAgIG5ld195aWR4ID0gbmV3X3lpZHggKyB0aGlzLnN0YXR1cy5zdGVwc2l6ZVsxXTtcbiAgICAgICAgaWYgKG5ld195aWR4ID4gdGhpcy5ncmlkLmdldFlsaW0oKVsxXSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR3JpZDogVXBwZXIgcmlnaHQgY29ybmVyIHJlYWNoZWQuJyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR3JpZDogdW5leHBlY3RlZCBkaXJlY3Rpb24gd2hlbiByZWFjaGluZyB1cHBlciB4IGJvdW5kYXJ5LicpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAobmV3X3hpZHggPCB0aGlzLmdyaWQuZ2V0WGxpbVswXSkge1xuICAgICAgaWYgKHRoaXMuc3RhdHVzLmRpcmVjdGlvbiA9PSBHcmlkRGlyZWN0aW9uLkxlZnQpIHtcbiAgICAgICAgLy8gbWluIHggdmFsdWUgcmVhY2hlZCwgY2hhbmdlIGRpcmVjdGlvbiB0byBkb3duLCBpLmUuIGtlZXBcbiAgICAgICAgLy8gaW5jcmVhc2luZyBkaWZmaWN1bHR5XG4gICAgICAgIG5ld194aWR4ID0gdGhpcy5ncmlkLmdldFhsaW0oKVswXTtcbiAgICAgICAgdGhpcy5zdGF0dXMuZGlyZWN0aW9uID0gR3JpZERpcmVjdGlvbi5Eb3duO1xuICAgICAgICB0aGlzLnN0YXR1cy5yZXZlcnNhbCA9IHRydWU7XG4gICAgICAgIHRoaXMucmV2ZXJzYWxfY291bnRlciA9IHRoaXMucmV2ZXJzYWxfY291bnRlciArIDE7XG4gICAgICAgIG5ld195aWR4ID0gbmV3X3lpZHggLSB0aGlzLnN0YXR1cy5zdGVwc2l6ZVsxXTtcbiAgICAgICAgaWYgKG5ld195aWR4IDwgdGhpcy5ncmlkLmdldFlsaW0oKVswXSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR3JpZDogTG93ZXIgbGVmdCBjb3JuZXIgcmVhY2hlZC4nKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdHcmlkOiB1bmV4cGVjdGVkIGRpcmVjdGlvbiB3aGVuIHJlYWNoaW5nIGxvd2VyIHggYm91bmRhcnkuJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgc3RvcHBpbmcgY29uZGl0aW9uc1xuICAgIGlmICh0aGlzLnJldmVyc2FsX2NvdW50ZXIgPj0gdGhpcy5uX21heF9yZXZlcnNhbHMpIHtcbiAgICAgIHRoaXMuc3RhdHVzLmZpbmlzaGVkID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuaGlzdG9yeS5sZW5ndGggPj0gdGhpcy5uX21heF9zdGVwcyAtIDEpIHtcbiAgICAgIHRoaXMuc3RhdHVzLmZpbmlzaGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBzYXZlIHRoZSBzdGF0dXMgdG8gZ3JpZCBoaXN0b3J5XG4gICAgbGV0IHN0YXR1c19jbG9uZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuc3RhdHVzKTtcbiAgICB0aGlzLmhpc3RvcnkucHVzaChzdGF0dXNfY2xvbmUpO1xuXG4gICAgLy8gbW92ZSB0byBuZXcgcG9pbnRcbiAgICB0aGlzLnN0YXR1cy54aWR4ID0gbmV3X3hpZHg7XG4gICAgdGhpcy5zdGF0dXMueWlkeCA9IG5ld195aWR4O1xuICB9XG5cbiAgZ2V0Q3VycmVudEdyaWRQYXJhbWV0ZXJzKCk6IFtudW1iZXIsIG51bWJlcl0ge1xuICAgIHJldHVybiB0aGlzLmdyaWQuZ2V0R3JpZFZhbHVlcyh0aGlzLnN0YXR1cy54aWR4LCB0aGlzLnN0YXR1cy55aWR4KTtcbiAgfVxuXG59XG5cbmV4cG9ydCBjbGFzcyBQYXJhbUdyaWQge1xuICBwcml2YXRlIHhsaW06IFtudW1iZXIsIG51bWJlcl07XG4gIHByaXZhdGUgeF9tYXhfaWR4OiBudW1iZXI7XG4gIHByaXZhdGUgeWxpbTogW251bWJlciwgbnVtYmVyXTtcbiAgcHJpdmF0ZSB5X21heF9pZHg6IG51bWJlcjtcbiAgcHJpdmF0ZSB4cmVzb2x1dGlvbjogbnVtYmVyO1xuICBwcml2YXRlIHlyZXNvbHV0aW9uOiBudW1iZXI7XG4gIHByaXZhdGUgeHZhbHVlczogQXJyYXk8bnVtYmVyPjtcbiAgcHJpdmF0ZSB5dmFsdWVzOiBBcnJheTxudW1iZXI+O1xuXG4gIGNvbnN0cnVjdG9yKHBhcmFtczoge3htaW46IG51bWJlciwgeG1heDogbnVtYmVyLCB5bWluOiBudW1iZXIsIHltYXg6IG51bWJlcixcbiAgICAgICAgICAgICAgeHJlczogbnVtYmVyLCB5cmVzOiBudW1iZXJ9KSB7XG5cbiAgICBpZiAocGFyYW1zLnhtYXggPCBwYXJhbXMueG1pbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd4bWluIG11c3QgYmUgbGVzcyB0aGFuIHhtYXgnKTtcbiAgICB9XG4gICAgdGhpcy54bGltID0gW3BhcmFtcy54bWluLCBwYXJhbXMueG1heF07XG4gICAgaWYgKHBhcmFtcy55bWF4IDwgcGFyYW1zLnltaW4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigneW1pbiBtdXN0IGJlIGxlc3MgdGhhbiB5bWF4Jyk7XG4gICAgfVxuICAgIHRoaXMueWxpbSA9IFtwYXJhbXMueW1pbiwgcGFyYW1zLnltYXhdO1xuXG4gICAgdGhpcy54cmVzb2x1dGlvbiA9IHBhcmFtcy54cmVzO1xuICAgIHRoaXMueXJlc29sdXRpb24gPSBwYXJhbXMueXJlcztcblxuICAgIGxldCB4X3NpemUgPSBNYXRoLmZsb29yKChwYXJhbXMueG1heCAtIHBhcmFtcy54bWluKS9wYXJhbXMueHJlcykgKyAxO1xuICAgIHRoaXMueHZhbHVlcyA9IG5ldyBBcnJheSh4X3NpemUpO1xuICAgIHRoaXMueF9tYXhfaWR4ID0geF9zaXplIC0gMTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMueF9tYXhfaWR4OyBpKyspIHtcbiAgICAgIHRoaXMueHZhbHVlc1tpXSA9IHBhcmFtcy54bWluICsgaSpwYXJhbXMueHJlcztcbiAgICB9XG4gICAgdGhpcy54dmFsdWVzW3RoaXMueF9tYXhfaWR4XSA9IHBhcmFtcy54bWF4O1xuXG4gICAgbGV0IHlfc2l6ZSA9IE1hdGguZmxvb3IoKHBhcmFtcy55bWF4IC0gcGFyYW1zLnltaW4pL3BhcmFtcy55cmVzKSArIDE7XG4gICAgdGhpcy55dmFsdWVzID0gbmV3IEFycmF5KHlfc2l6ZSk7XG4gICAgdGhpcy55X21heF9pZHggPSB5X3NpemUgLSAxO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy55X21heF9pZHg7IGkrKykge1xuICAgICAgdGhpcy55dmFsdWVzW2ldID0gcGFyYW1zLnltaW4gKyBpKnBhcmFtcy55cmVzO1xuICAgIH1cbiAgICB0aGlzLnl2YWx1ZXNbdGhpcy55X21heF9pZHhdID0gcGFyYW1zLnltYXg7XG5cbiAgfVxuXG4gIGdldFhsaW0oKTogW251bWJlciwgbnVtYmVyXSB7XG4gICAgcmV0dXJuIHRoaXMueGxpbTtcbiAgfVxuXG4gIGdldFlsaW0oKTogW251bWJlciwgbnVtYmVyXSB7XG4gICAgcmV0dXJuIHRoaXMueWxpbTtcbiAgfVxuXG4gIGdldEdyaWRWYWx1ZXMoeGlkeCwgeWlkeCk6IFtudW1iZXIsIG51bWJlcl0ge1xuICAgIGlmICh4aWR4ID4gdGhpcy54X21heF9pZHgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigneGlkeCBleGNlZWRzIGdyaWQgcmFuZ2UnKTtcbiAgICB9XG4gICAgaWYgKHlpZHggPiB0aGlzLnlfbWF4X2lkeCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd5aWR4IGV4Y2VlZHMgZ3JpZCByYW5nZScpO1xuICAgIH1cblxuICAgIHJldHVybiBbdGhpcy54dmFsdWVzW3hpZHhdLCB0aGlzLnl2YWx1ZXNbeWlkeF1dO1xuICB9XG5cbn1cbiJdfQ==